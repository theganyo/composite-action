on: [push]

jobs:
  test-cloud:
    runs-on: ubuntu-latest
    name: Run against google cloud registry
    steps:
    - uses: actions/checkout@v3
    - uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GOOGLE_CREDENTIALS }}'
    - name: Set up the Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
    - name: Capture GOOGLE_CLOUD_PROJECT env
      run: echo "GOOGLE_CLOUD_PROJECT=$GOOGLE_CLOUD_PROJECT" >> $GITHUB_ENV
    - name: Verify the Google Cloud SDK installation
      run: gcloud info
    - uses: ./setup-registry
      with:
        project: ${{ env.GOOGLE_CLOUD_PROJECT }}
        address: apigeeregistry.googleapis.com:443
        location: global
        token-source: gcloud auth print-access-token
        insecure: false          
    - name: Run a query
      run: registry get artifacts

  test-local-sqlite:
    runs-on: ubuntu-latest
    name: Run against local registry on sqlite3
    steps:
    - uses: actions/checkout@v3
    - uses: ./setup-registry
      with:
        project: project
        address: localhost:8080
        location: global
        insecure: true
    - name: Create a project
      run: registry rpc admin create-project --project_id project
    - name: Apply an API
      run: registry apply -f api.yaml
    - name: Run a query
      run: registry get apis
    services:
      registry-server:
        image: ghcr.io/apigee/registry-server:main
        env:
          REGISTRY_DATABASE_DRIVER: sqlite3
          REGISTRY_DATABASE_CONFIG: ""
          REGISTRY_LOGGING_LEVEL: debug
          REGISTRY_LOGGING_FORMAT: text
          REGISTRY_PUBSUB_ENABLE: false
          REGISTRY_PUBSUB_PROJECT: ""
          PORT: 8080
        ports:
          - 8080:8080

  test-local-postgres:
    runs-on: ubuntu-latest
    name: Run against local registry on postgres
    steps:
    - uses: actions/checkout@v3
    - uses: ./setup-registry
      with:
        project: project
        address: localhost:8080
        location: global
        insecure: true
    - name: Create a project
      run: registry rpc admin create-project --project_id project
    - name: Apply an API
      run: registry apply -f api.yaml
    - name: Run a query
      run: registry get apis
    services:
      registry-database:
        image: postgres:latest
        env:
          POSTGRES_PASSWORD: passw0rd
          POSTGRES_DB: apigee_registry
          POSTGRES_USER: postgres
          PGUSER: postgres
        options: >- # wait until postgres has started
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      registry-server:
        image: ghcr.io/apigee/registry-server:main
        env:
          REGISTRY_DATABASE_DRIVER: postgres
          REGISTRY_DATABASE_CONFIG: host=registry-database port=5432 user=postgres dbname=apigee_registry password=passw0rd sslmode=disable
          REGISTRY_LOGGING_LEVEL: debug
          REGISTRY_LOGGING_FORMAT: text
          REGISTRY_PUBSUB_ENABLE: false
          REGISTRY_PUBSUB_PROJECT: ""
          PORT: 8080
        ports:
          - 8080:8080
